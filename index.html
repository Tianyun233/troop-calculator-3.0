<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Trap Calculator - Pro v3.4</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
        .lang-container { text-align: right; margin-bottom: 10px; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: white; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .author-credit { text-align: center; color: #7f8c8d; margin-bottom: 20px; font-size: 1.1em; } 
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-title { font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #555; }
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .input-group label { font-weight: bold; min-width: 130px; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px; }
        input[type="checkbox"] { transform: scale(1.2); margin-right: 8px; cursor: pointer; }
        .tier-select { min-width: 220px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.95em; }
        th { background-color: #f8f9fa; color: #444; }
        input.table-input { width: 80%; padding: 5px; text-align: center; }
        .btn-calc { width: 100%; padding: 15px; background-color: #3498db; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; transition: background 0.3s; margin-top: 20px; }
        .btn-calc:hover { background-color: #2980b9; }
        #result-area { display: none; background-color: #e8f6f3; border: 1px solid #a3e4d7; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
        .result-highlight { font-weight: bold; color: #d35400; }
        .notice { font-size: 0.85em; color: #e67e22; margin-top: 10px; font-style: italic; border-top: 1px dashed #ccc; padding-top: 10px; line-height: 1.5; }
    </style>
</head>
<body>

    <h1 data-i18n="title">ğŸ» æ‰“ç†Šé…å…µæ¯”ä¾‹è®¡ç®—å™¨</h1>
    <p class="author-credit">ä½œè€…: #46 çƒé¾ & Gemini</p>

    <div class="card">
        <div class="section-title">æˆ˜æœ¯é…ç½®</div>
        
        <div class="input-group">
            <label>å‡ºå¾å®¹é‡ï¼š</label>
            <input type="number" id="totalCapacity" value="160000">
        </div>

        <div class="input-group">
            <label>å…µç§ç­‰çº§ï¼š</label>
            <select id="goldLevel" class="tier-select">
                <option value="0">ä½äºé»„é‡‘ 3 (æ— åŠ æˆ)</option>
                <option value="3">é»„é‡‘ 3 (ä¼¤å®³ 1.1x)</option>
                <option value="5">é»„é‡‘ 5 (ä¼¤å®³ 1.15x)</option>
                <option value="8">é»„é‡‘ 8 (å¼“ 1.225x + 4%æ”»)</option>
            </select>
        </div>

        <div class="input-group">
            <label>ç½—èé…ç½®ï¼š</label>
            <select id="rosaLevel" class="tier-select">
                <option value="0">ä¸ä½¿ç”¨ç½—è (æ— å€ç‡)</option>
                <option value="0.3">ä½¿ç”¨ç½—è (1.3å€ç‡)</option>
                <option value="0.2">ä½¿ç”¨ç½—è (1.2å€ç‡)</option>
            </select>
        </div>

        <div class="input-group">
            <label style="cursor: pointer; display: flex; align-items: center; margin-right: 20px;">
                <input type="checkbox" id="buffMedicine">
                <span>ä½¿ç”¨æ”»å‡»å¼ºåŒ–è¯ (25% æ”»å‡»)</span>
            </label>
            <label style="cursor: pointer; display: flex; align-items: center;">
                <input type="checkbox" id="minInfToggle" checked>
                <span>å¼ºåˆ¶ç›¾å…µæœ€å° 5,000 äºº</span>
            </label>
        </div>
    </div>

    <div class="card">
        <div class="section-title">é¢æ¿ç™¾åˆ†æ¯”åŠ æˆ (%)</div>
        <table>
            <thead>
                <tr>
                    <th>å…µç§</th>
                    <th>æ”»å‡»åŠ æˆ (%)</th>
                    <th>æ€ä¼¤åŠ æˆ (%)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ğŸ›¡ï¸ ç›¾å…µ (1N)</td>
                    <td><input type="number" class="table-input" id="inf_buff_atk" value="300"></td>
                    <td><input type="number" class="table-input" id="inf_buff_leth" value="200"></td>
                </tr>
                <tr>
                    <td>ğŸ éª‘å…µ (3N)</td>
                    <td><input type="number" class="table-input" id="rid_buff_atk" value="300"></td>
                    <td><input type="number" class="table-input" id="rid_buff_leth" value="200"></td>
                </tr>
                <tr>
                    <td>ğŸ¹ å¼“å…µ (4N)</td>
                    <td><input type="number" class="table-input" id="hun_buff_atk" value="400"></td>
                    <td><input type="number" class="table-input" id="hun_buff_leth" value="250"></td>
                </tr>
            </tbody>
        </table>

        <button class="btn-calc" onclick="calculateOptimalRatio()">å¼€å§‹è®¡ç®—æœ€ä½³æ¯”ä¾‹</button>
    </div>

    <div class="card" id="result-area">
        <div class="section-title">âš–ï¸ æœ€ä½³å‡ºå¾æ–¹æ¡ˆ</div>
        <div id="result-content"></div>
    </div>

    <script>
        function calculateOptimalRatio() {
            const capacity = parseFloat(document.getElementById('totalCapacity').value) || 0;
            const goldLevel = parseInt(document.getElementById('goldLevel').value);
            const rosaBonus = parseFloat(document.getElementById('rosaLevel').value);
            const useMedicine = document.getElementById('buffMedicine').checked;
            const useMinInf = document.getElementById('minInfToggle').checked;

            if (capacity <= 0) return;

            const bAtkInf = parseFloat(document.getElementById('inf_buff_atk').value) || 0;
            const bLethInf = parseFloat(document.getElementById('inf_buff_leth').value) || 0;
            const bAtkRid = parseFloat(document.getElementById('rid_buff_atk').value) || 0;
            const bLethRid = parseFloat(document.getElementById('rid_buff_leth').value) || 0;
            const bAtkHun = parseFloat(document.getElementById('hun_buff_atk').value) || 0;
            const bLethHun = parseFloat(document.getElementById('hun_buff_leth').value) || 0;

            // 1. åŒä¸€ä¹˜åŒºçš„åŸºç¡€ç³»æ•° (è¯æ°´ = 1.25, æ— è¯æ°´ = 1.0)
            let globalMultiplier = useMedicine ? 1.25 : 1.0;

            // 2. å…µç§ç‰¹å®šä¼¤å®³ç³»æ•° (M)
            let mRid = 0.8; 
            let mHun = 1.21;
            let goldAtkHun = 0;

            if (goldLevel >= 3) { mRid *= 1.1; mHun *= 1.1; }
            if (goldLevel >= 5) { mRid = 0.8 * 1.15; mHun = 1.21 * 1.15; }
            if (goldLevel >= 8) { mRid = 0.8 * 1.15; mHun = 1.21 * 1.225; goldAtkHun = 4; }

            // 3. è®¡ç®—å„å…µç§å¼ºåº¦ç³»æ•° S
            // ç›¾å…µ/éª‘å…µå—å…¨å±€è¯æ°´ä¹˜åŒºå½±å“ (åŠ æ³•é€»è¾‘ä¸­ï¼Œéå åŠ é¡¹ç»´æŒ globalMultiplier)
            const sInf = (1 + bAtkInf/100) * globalMultiplier * (1 + bLethInf/100) * 1;
            const sRid = (1 + bAtkRid/100) * globalMultiplier * (1 + bLethRid/100) * 3 * mRid;
            
            // å¼“å…µæ”»å‡»ä¹˜åŒºï¼šglobalMultiplier (1.0 or 1.25) + rosaBonus (0, 0.2, 0.3)
            const archerMultiplierBucket = globalMultiplier + rosaBonus;
            const sHun = (1 + (bAtkHun + goldAtkHun)/100) * archerMultiplierBucket * (1 + bLethHun/100) * 4 * mHun;

            // 4. è®¡ç®—æƒé‡ W = S^2
            const wInf = Math.pow(sInf, 2);
            const wRid = Math.pow(sRid, 2);
            const wHun = Math.pow(sHun, 2);
            const totalW = wInf + wRid + wHun;

            // 5. åˆ†é…
            let finalInf, finalRid, finalHun, showNotice = false;
            let idealInf = Math.round(capacity * (wInf / totalW));

            if (useMinInf && idealInf < 5000 && capacity > 5000) {
                finalInf = 5000;
                showNotice = true;
                let remainCap = capacity - 5000;
                let subTotalW = wRid + wHun;
                finalRid = Math.round(remainCap * (wRid / subTotalW));
                finalHun = remainCap - finalRid;
            } else {
                finalInf = idealInf;
                finalRid = Math.round(capacity * (wRid / totalW));
                finalHun = Math.max(0, capacity - finalInf - finalRid);
            }

            // 6. æ¸²æŸ“
            const resultArea = document.getElementById('result-area');
            const resultContent = document.getElementById('result-content');
            resultArea.style.display = 'block';
            const getP = (val) => ((val / capacity) * 100).toFixed(2);

            resultContent.innerHTML = `
                <div class="result-row"><span>ğŸ›¡ï¸ ç›¾å…µ</span> <span><span class="result-highlight">${finalInf.toLocaleString()}</span> (${getP(finalInf)}%)</span></div>
                <div class="result-row"><span>ğŸ éª‘å…µ</span> <span><span class="result-highlight">${finalRid.toLocaleString()}</span> (${getP(finalRid)}%)</span></div>
                <div class="result-row"><span>ğŸ¹ å¼“å…µ</span> <span><span class="result-highlight">${finalHun.toLocaleString()}</span> (${getP(finalHun)}%)</span></div>
                <div style="font-size:0.9em; margin-top:10px; color:#7f8c8d; border-top:1px solid #eee; padding-top:10px;">
                    æ€»è®¡å‡ºå¾: ${(finalInf+finalRid+finalHun).toLocaleString()} <br>
                    å½“å‰å¼“å…µæ”»å‡»ä¿®æ­£ç³»æ•°: ${archerMultiplierBucket.toFixed(2)}
                </div>
                ${showNotice ? `<div class="notice">âš ï¸ æç¤ºï¼šç›¾å…µå·²è¡¥é½è‡³æœ€å°å€¼ï¼ˆ5000äººï¼‰ã€‚è‹¥è¦æŸ¥çœ‹çº¯ç†è®ºæœ€é«˜ä¼¤å®³æ¯”ä¾‹ï¼Œè¯·å–æ¶ˆå‹¾é€‰â€œå¼ºåˆ¶ç›¾å…µâ€ã€‚</div>` : ''}
            `;
        }
    </script>
</body>
</html>
