<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Trap Calculator - Pro v3.4</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
        .lang-container { text-align: right; margin-bottom: 10px; }
        select#langSelector { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .author-credit { text-align: center; color: #7f8c8d; margin-bottom: 20px; font-size: 1.1em; } 
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-title { font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #555; }
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .input-group label { font-weight: bold; min-width: 130px; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px; }
        input[type="checkbox"] { transform: scale(1.2); margin-right: 8px; cursor: pointer; }
        select.tier-select { padding: 8px; border-radius: 4px; border: 1px solid #aaa; background-color: #fff; min-width: 200px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.95em; }
        th { background-color: #f8f9fa; color: #444; }
        input.table-input { width: 80%; padding: 5px; text-align: center; }
        .btn-calc { width: 100%; padding: 15px; background-color: #3498db; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; transition: background 0.3s; margin-top: 20px; }
        .btn-calc:hover { background-color: #2980b9; }
        #result-area { display: none; background-color: #e8f6f3; border: 1px solid #a3e4d7; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
        .result-highlight { font-weight: bold; color: #d35400; }
        .notice { font-size: 0.85em; color: #e67e22; margin-top: 10px; font-style: italic; border-top: 1px dashed #ccc; padding-top: 10px; }
    </style>
</head>
<body>

    <div class="lang-container">
        <select id="langSelector" onchange="changeLanguage(this.value)">
            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            <option value="en">English</option>
        </select>
    </div>

    <h1 data-i18n="title">ğŸ» æ‰“ç†Šé…å…µæ¯”ä¾‹è®¡ç®—å™¨</h1>
    <p class="author-credit"><span data-i18n="author_label">ä½œè€…</span>: #46 çƒé¾ & Gemini</p>

    <div class="card">
        <div class="section-title" data-i18n="config_title">æˆ˜æœ¯é…ç½®</div>
        
        <div class="input-group">
            <label data-i18n="label_capacity">å‡ºå¾å®¹é‡ï¼š</label>
            <input type="number" id="totalCapacity" value="160000">
        </div>

        <div class="input-group">
            <label data-i18n="label_gold_level">å…µç§ç­‰çº§ï¼š</label>
            <select id="goldLevel" class="tier-select">
                <option value="0">ä½äºé»„é‡‘ 3 (æ— åŠ æˆ)</option>
                <option value="3">é»„é‡‘ 3 (ä¼¤å®³ 1.1x)</option>
                <option value="5">é»„é‡‘ 5 (ä¼¤å®³ 1.15x)</option>
                <option value="8">é»„é‡‘ 8 (å¼“ 1.225x + 4%æ”»)</option>
            </select>
        </div>

        <div class="input-group">
            <label data-i18n="label_rosa_select">ç½—èæŠ€èƒ½ï¼š</label>
            <select id="rosaSkill" class="tier-select">
                <option value="1.0">æ—  (1.0x)</option>
                <option value="1.2">ä½¿ç”¨ç½—è (1.2å€ç‡)</option>
                <option value="1.3" selected>ä½¿ç”¨ç½—è (1.3å€ç‡)</option>
            </select>
        </div>

        <div class="input-group">
            <label style="cursor: pointer; display: flex; align-items: center;">
                <input type="checkbox" id="minInfToggle" checked>
                <span data-i18n="label_min_inf">å¼ºåˆ¶ç›¾å…µæœ€å° 5,000 äºº</span>
            </label>
        </div>
    </div>

    <div class="card">
        <div class="section-title" data-i18n="stats_title">é¢æ¿ç™¾åˆ†æ¯”åŠ æˆ (%)</div>
        <table>
            <thead>
                <tr>
                    <th data-i18n="th_troop">å…µç§</th>
                    <th data-i18n="th_buff_atk">æ”»å‡»åŠ æˆ (%)</th>
                    <th data-i18n="th_buff_leth">æ€ä¼¤åŠ æˆ (%)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-i18n="troop_inf">ğŸ›¡ï¸ ç›¾å…µ (1N)</td>
                    <td><input type="number" class="table-input" id="inf_buff_atk" value="300"></td>
                    <td><input type="number" class="table-input" id="inf_buff_leth" value="200"></td>
                </tr>
                <tr>
                    <td data-i18n="troop_rid">ğŸ éª‘å…µ (3N)</td>
                    <td><input type="number" class="table-input" id="rid_buff_atk" value="300"></td>
                    <td><input type="number" class="table-input" id="rid_buff_leth" value="200"></td>
                </tr>
                <tr>
                    <td data-i18n="troop_hun">ğŸ¹ å¼“å…µ (4N)</td>
                    <td><input type="number" class="table-input" id="hun_buff_atk" value="400"></td>
                    <td><input type="number" class="table-input" id="hun_buff_leth" value="250"></td>
                </tr>
            </tbody>
        </table>

        <button class="btn-calc" onclick="calculateOptimalRatio()" data-i18n="btn_calc">å¼€å§‹è®¡ç®—æœ€ä½³æ¯”ä¾‹</button>
    </div>

    <div class="card" id="result-area">
        <div class="section-title" data-i18n="result_title">âš–ï¸ æœ€ä½³å‡ºå¾æ–¹æ¡ˆ</div>
        <div id="result-content"></div>
    </div>

    <script>
        const translations = {
            "zh-CN": {
                title: "ğŸ» æ‰“ç†Šé…å…µæ¯”ä¾‹è®¡ç®—å™¨",
                author_label: "ä½œè€…",
                config_title: "æˆ˜æœ¯é…ç½®",
                label_capacity: "å‡ºå¾å®¹é‡ï¼š",
                label_gold_level: "å…µç§é»„é‡‘ç­‰çº§ï¼š",
                label_rosa_select: "ç½—èæŠ€èƒ½ï¼š",
                label_min_inf: "å¼ºåˆ¶ç›¾å…µæœ€å° 5,000 äºº",
                stats_title: "é¢æ¿ç™¾åˆ†æ¯”åŠ æˆ (%)",
                th_troop: "å…µç§",
                th_buff_atk: "åŠ æˆæ”» (%)",
                th_buff_leth: "åŠ æˆæ€ (%)",
                troop_inf: "ğŸ›¡ï¸ ç›¾å…µ",
                troop_rid: "ğŸ éª‘å…µ",
                troop_hun: "ğŸ¹ å¼“å…µ",
                btn_calc: "å¼€å§‹è®¡ç®—æœ€ä½³æ¯”ä¾‹",
                result_title: "âš–ï¸ æœ€ä½³å‡ºå¾æ–¹æ¡ˆ",
                msg_correction: "âš ï¸ æç¤ºï¼šç›¾å…µå·²è¡¥é½è‡³ 5000 äººï¼Œå…¶ä½™å…µåŠ›å·²æŒ‰æœ€ä¼˜æ¯”ä¾‹åˆ†é…ã€‚"
            },
            "en": {
                title: "Bear Trap Calculator",
                author_label: "Author",
                config_title: "Tactical Config",
                label_capacity: "March Capacity:",
                label_gold_level: "Gold Tier:",
                label_rosa_select: "Rosa Skill:",
                label_min_inf: "Force Min 5,000 Infantry",
                stats_title: "Panel Buffs (%)",
                th_troop: "Troop Type",
                th_buff_atk: "Atk Buff (%)",
                th_buff_leth: "Leth Buff (%)",
                troop_inf: "ğŸ›¡ï¸ Infantry",
                troop_rid: "ğŸ Cavalry",
                troop_hun: "ğŸ¹ Archer",
                btn_calc: "Calculate Best Ratio",
                result_title: "âš–ï¸ Optimal Formation",
                msg_correction: "âš ï¸ Note: Infantry fixed at 5k. Others redistributed optimally."
            }
        };

        let currentLang = "zh-CN";

        function changeLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
        }

        function calculateOptimalRatio() {
            const t = translations[currentLang];
            const capacity = parseFloat(document.getElementById('totalCapacity').value) || 0;
            const goldLevel = parseInt(document.getElementById('goldLevel').value);
            const rosaMultiplier = parseFloat(document.getElementById('rosaSkill').value);
            const useMinInf = document.getElementById('minInfToggle').checked;

            if (capacity <= 0) return;

            const bAtkInf = parseFloat(document.getElementById('inf_buff_atk').value) || 0;
            const bLethInf = parseFloat(document.getElementById('inf_buff_leth').value) || 0;
            const bAtkRid = parseFloat(document.getElementById('rid_buff_atk').value) || 0;
            const bLethRid = parseFloat(document.getElementById('rid_buff_leth').value) || 0;
            const bAtkHun = parseFloat(document.getElementById('hun_buff_atk').value) || 0;
            const bLethHun = parseFloat(document.getElementById('hun_buff_leth').value) || 0;

            // 1. é»„é‡‘ç­‰çº§ä¿®æ­£
            let mRid = 0.8; 
            let mHun = 1.21;
            let goldAtkHun = 0;

            if (goldLevel >= 3) { mRid *= 1.1; mHun *= 1.1; }
            if (goldLevel >= 5) { mRid = 0.8 * 1.15; mHun = 1.21 * 1.15; }
            if (goldLevel >= 8) { mRid = 0.8 * 1.15; mHun = 1.21 * 1.225; goldAtkHun = 4; }

            // 2. å¼ºåº¦ç³»æ•° S è®¡ç®—
            const sInf = (1 + bAtkInf/100) * (1 + bLethInf/100) * 1;
            const sRid = (1 + bAtkRid/100) * (1 + bLethRid/100) * 3 * mRid;
            
            // ç½—èåŠ æˆç›´æ¥ä½œç”¨äºå¼“å…µæ”»å‡»åŒº
            const sHun = (1 + (bAtkHun + goldAtkHun)/100) * rosaMultiplier * (1 + bLethHun/100) * 4 * mHun;

            // 3. æƒé‡ W = S^2
            const wInf = Math.pow(sInf, 2);
            const wRid = Math.pow(sRid, 2);
            const wHun = Math.pow(sHun, 2);
            const totalW = wInf + wRid + wHun;

            // 4. åˆ†é…
            let finalInf, finalRid, finalHun;
            let showNotice = false;
            let idealInf = Math.round(capacity * (wInf / totalW));

            if (useMinInf && idealInf < 5000 && capacity > 5000) {
                finalInf = 5000;
                showNotice = true;
                let remainCap = capacity - 5000;
                let subTotalW = wRid + wHun;
                finalRid = Math.round(remainCap * (wRid / subTotalW));
                finalHun = remainCap - finalRid;
            } else {
                finalInf = idealInf;
                finalRid = Math.round(capacity * (wRid / totalW));
                finalHun = capacity - finalInf - finalRid;
            }

            // 5. æ¸²æŸ“
            const resultArea = document.getElementById('result-area');
            const resultContent = document.getElementById('result-content');
            resultArea.style.display = 'block';

            const getP = (val) => ((val / capacity) * 100).toFixed(2);

            resultContent.innerHTML = `
                <div class="result-row"><span>${t.troop_inf}</span> <span><span class="result-highlight">${finalInf.toLocaleString()}</span> (${getP(finalInf)}%)</span></div>
                <div class="result-row"><span>${t.troop_rid}</span> <span><span class="result-highlight">${finalRid.toLocaleString()}</span> (${getP(finalRid)}%)</span></div>
                <div class="result-row"><span>${t.troop_hun}</span> <span><span class="result-highlight">${finalHun.toLocaleString()}</span> (${getP(finalHun)}%)</span></div>
                <div style="font-size:0.9em; margin-top:10px; color:#7f8c8d; border-top:1px solid #eee; padding-top:10px;">æ€»è®¡: ${(finalInf+finalRid+finalHun).toLocaleString()}</div>
                ${showNotice ? `<div class="notice">${t.msg_correction}</div>` : ''}
            `;
        }
    </script>
</body>
</html>
